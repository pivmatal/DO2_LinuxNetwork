## Part 1. Инструмент **ipcalc**

**== Задание ==**

##### Поднять виртуальную машину (далее -- ws1)

#### 1.1. Сети и маски
##### Определить и записать в отчёт:
##### 1) адрес сети *192.167.38.54/13*:
-  Адрес сети в этом задании 192.160.0.0
<img src="./screen/part1.1.png"/><br>

##### 2) перевод маски *255.255.255.0* в префиксную и двоичную запись, */15* в обычную и двоичную, *11111111.11111111.11111111.11110000* в обычную и1 префиксную
- Преобразуем обычную запись сетевой маски 255.255.255.0 в префиксную и двоичную запись:
<img src="./screen/part1.2.png"/><br> Обычной записи сетевой маски 255.255.255.0 соответствует префиксная запись /24 и двоичная 1111 1111.1111 1111.1111 1111.0000 0000.


- Преобразуем префиксную запись сетевой маски */15* в обычную и двоичную:
<img src="./screen/part1.3.png"/><br>Префиксной записи сетевой маски /15 соответствует обычная запись 255.254.0.0 и двоичная 1111 1111.1111 1110.0000 0000.0000 0000.

- Преобразуем двоичную запись сетевой маски *11111111.11111111.11111111.11110000* в обычную и префиксную:
<img src="./screen/part1.4.png"/><br>Обычной записи сетевой маски соответствует префиксная запись /28 и обычная 255.255.255.240.


##### 3) минимальный и максимальный хост в сети *12.167.38.4* при масках: */8*, *11111111.11111111.00000000.00000000*, *255.255.254.0* и */4*

- 3.1) Определим адреса минимального и максимального хоста в сети 12.167.38.4 при использовании сетевой маски в префиксной форме /8:
<img src="./screen/part1.5.png"/><br>Минимальный адрес хоста будет - 12.0.0.1 и максимальный адрес хоста будет - 12.255.255.254.

- 3.2) Определим адреса минимального и максимального хоста в сети 12.167.38.4 при использовании сетевой маски в двоичной форме *11111111.11111111.00000000.00000000*:
<img src="./screen/part1.6.png"/><br>Минимальный адрес хоста будет - 12.167.0.1 и максимальный адрес хоста будет - 12.167.255.254

- 3.3) Определим адреса минимального и максимального хоста в сети 12.167.38.4 при использовании сетевой маски в обычной форме *255.255.254.0*:
<img src="./screen/part1.7.png"/><br>Минимальный адрес хоста будет - 12.167.38.1 и максимальный адрес хоста будет - 12.167.39.254

- 3.4) Определим адреса минимального и максимального хоста в сети 12.167.38.4 при использовании сетевой маски в префиксной форме /4:
<img src="./screen/part1.8.png"/><br>Минимальный адрес хоста будет - 0.0.0.1 и максимальный адрес хоста будет - 15.255.255.254.

#### 1.2. localhost
##### Определить и записать в отчёт, можно ли обратиться к приложению, работающему на localhost, со следующими IP: *194.34.23.100*, *127.0.0.2*, *127.1.0.1*, *128.0.0.1*

- *194.34.23.100*:
<img src="./screen/part1.9.png"/><br>Так как адрес принадлежит сегменту публичных адресов, то обращение к приложению, работающему на localhost, невозможно.


- *127.0.0.2*:
<img src="./screen/part1.10.png"/><br>Адрес принадлежит сегменту частных адресов и входит в сегмент looback коммуникации с localhost, значит обращение к приложению, работающему на localhost, возможно.

- *127.1.0.1*:
<img src="./screen/part1.11.png"/><br>Адрес принадлежит сегменту частных адресов и входит в сегмент looback коммуникации с localhost, значит обращение к приложению, работающему на localhost, возможно.

- *128.0.0.1*:
<img src="./screen/part1.12.png"/><br> Так как адрес принадлежит сегменту публичных адресов, то обращение к приложению, работающему на localhost, невозможно.

#### 1.3. Диапазоны и сегменты сетей
##### Определить и записать в отчёт:
##### 1) какие из перечисленных IP можно использовать в качестве публичного, а какие только в качестве частных: *10.0.0.45*, *134.43.0.2*, *192.168.4.2*, *172.20.250.4*, *172.0.2.1*, *192.172.0.1*, *172.68.0.2*, *172.16.255.255*, *10.10.10.10*, *192.169.168.1*

- *10.0.0.45*:
<img src="./screen/part1.13.png"/><br> Адрес принадлежит сегменту частных адресов, значит предложенный адрес можно использовать как частный.

- *134.43.0.2*:
<img src="./screen/part1.14.png"/><br> Адрес принадлежит сегменту публичных адресов, таким образом предложенный адрес можно использовать как публичный.

- *192.168.4.2*:
<img src="./screen/part1.15.png"/><br>Адрес принадлежит сегменту частных адресов, значит предложенный адрес можно использовать как частный.

- *172.20.250.4*:
<img src="./screen/part1.16.png"/><br>Адрес принадлежит сегменту частных адресов, значит предложенный адрес можно использовать как частный.

- *172.0.2.1*:
<img src="./screen/part1.17.png"/><br>Адрес принадлежит сегменту публичных адресов, таким образом предложенный адрес можно использовать как публичный.

- *192.172.0.1*:
<img src="./screen/part1.18.png"/><br>Адрес принадлежит сегменту публичных адресов, таким образом предложенный адрес можно использовать как публичный.

-  *172.68.0.2*:
<img src="./screen/part1.19.png"/><br>Адрес принадлежит сегменту публичных адресов, таким образом предложенный адрес можно использовать как публичный.

-  *172.16.255.255*:
<img src="./screen/part1.20.png"/><br>Адрес принадлежит сегменту частных адресов, значит предложенный адрес можно использовать как частный.

- *10.10.10.10*:
<img src="./screen/part1.21.png"/><br>Адрес принадлежит сегменту частных адресов, значит предложенный адрес можно использовать как частный.

-  *192.169.168.1*:
<img src="./screen/part1.22.png"/><br> Адрес принадлежит сегменту публичных адресов, таким образом предложенный адрес можно использовать как публичный.

##### 2) какие из перечисленных IP адресов шлюза возможны у сети *10.10.0.0/18*: *10.0.0.1*, *10.10.0.2*, *10.10.10.10*, *10.10.100.1*, *10.10.1.255*

- <img src="./screen/part1.23.png"/><br>
- **10.0.0.1** - адрес находится вне указанного сегмента адресов сети, поэтому не может являться адресом шлюза
- **10.10.0.2** - адрес находится в указанном сегменте адресов сети, поэтому может являться адресом шлюза
- **10.10.10.10** - адрес находится в указанном сегменте адресов сети, поэтому может являться адресом шлюза
- **10.10.100.1** - адрес находится вне указанного сегмента адресов сети, поэтому не может являться адресом шлюза
- **10.10.1.255** - адрес находится в указанном сегменте адресов сети, поэтому может являться адресом шлюза

## Part 2. Статическая маршрутизация между двумя машинами

- С помощью команды `ip a` посмотрели существующие сетевые интерфейсы на ws1 и ws2: 
<img src="./screen/part2.1.png"/><br>
<img src="./screen/part2.2.png"/><br>

- Описали сетевой интерфейс, соответствующий внутренней сети, на обеих машинах и задали следующие адреса и маски: ws1 - 192.168.100.10, маска /16, ws2 - 172.24.116.8, маска /12:
<img src="./screen/part2.3.png"/><br>
<img src="./screen/part2.4.png"/><br>

- Выполнили команду netplan apply для перезапуска сервиса сети:
<img src="./screen/part2.5.png"/><br>
<img src="./screen/part2.6.png"/><br>

#### 2.1. Добавление статического маршрута вручную
- Добавили статический маршрут от одной машины до другой и обратно при помощи команды вида `ip r add`:
<img src="./screen/part2.7.png"/><br>
<img src="./screen/part2.8.png"/><br>

- Пропинговали соединение между машинами:
<img src="./screen/part2.9.png"/><br>
<img src="./screen/part2.10.png"/><br>

#### 2.2. Добавление статического маршрута с сохранением

- Перезапустили машины командой `reboot`.
Добавили статический маршрут от одной машины до другой с помощью файла *etc/netplan/00-installer-config.yaml*
<img src="./screen/part2.11.png"/><br>
<img src="./screen/part2.12.png"/><br>

- Еще раз пропинговали соединение между машинами: 
<img src="./screen/part2.13.png"/><br>
<img src="./screen/part2.14.png"/><br>

## Part 3. Утилита **iperf3**

#### 3.1. Скорость соединения
##### Перевести и записать в отчёт: 8 Mbps в MB/s, 100 MB/s в Kbps, 1 Gbps в Mbps:

- 8 Mbps = 1 MB/s
- 100 MB/s = 819200 kbps
- 1 Gbps = 1024 Mbps


#### 3.2. Утилита **iperf3**
##### Измерить скорость соединения между ws1 и ws2:

- ws1 - сервер, а ws2 - рабочая станция с которой осуществляется связь:
<img src="./screen/part3.1.png"/><br>
<img src="./screen/part3.2.png"/><br>

- ws2 - сервер, а ws1 - рабочая станция с которой осуществляется связь:
<img src="./screen/part3.3.png"/><br>
<img src="./screen/part3.4.png"/><br>

- В результате успешно измерили скорость соединения между двумя рабочими станциями **ws1 и ws2**.

## Part 4. Сетевой экран

#### 4.1. Утилита **iptables**
##### Создать файл */etc/firewall.sh*, имитирующий фаерволл, на ws1 и ws2:
```shell
#!/bin/sh

# Удаление всех правил в таблице "filter" (по-умолчанию).
iptables –F
iptables -X
```
##### Нужно добавить в файл подряд следующие правила:
##### 1) на ws1 применить стратегию когда в начале пишется запрещающее правило, а в конце пишется разрешающее правило (это касается пунктов 4 и 5)
##### 2) на ws2 применить стратегию когда в начале пишется разрешающее правило, а в конце пишется запрещающее правило (это касается пунктов 4 и 5)
##### 3) открыть на машинах доступ для порта 22 (ssh) и порта 80 (http)
##### 4) запретить *echo reply* (машина не должна "пинговаться”, т.е. должна быть блокировка на OUTPUT)
##### 5) разрешить *echo reply* (машина должна "пинговаться")

- на обоих машинах нет правил iptables: 
<img src="./screen/part4.1.png"/><br>
<img src="./screen/part4.2.png"/><br>

- Создадим bash-скрипты, которые добавят набор правил в **iptables** для **ws1** и **ws2** (набор правил дан нам этим заданием):
<img src="./screen/part4.3.png"/><br>
<img src="./screen/part4.4.png"/><br>

- Запустим файлы на обеих машинах командами chmod +x /etc/firewall.sh и /etc/firewall.sh и проверим таблицу правил:
<img src="./screen/part4.5.png"/><br>
<img src="./screen/part4.6.png"/><br>

- Пояснение: Для двух машин, ws1 и ws2, используются различные стратегии для правил цепочки OUTPUT в iptables. Для ws1, правило для исходящего трафика протокола ICMP, который используется утилитой ping, сначала блокируется, а затем разрешается. Это означает, что при пинговании ws1, ответы (эхо) не будут выходить, так как первое правило в цепочке OUTPUT заблокирует все исходящие ответы. В то же время, для ws2 ситуация будет противоположной, поскольку "эхо" (ответ) от ping будет пропускаться iptables. Первое правило в цепочке правил, которые выполняется, пропускает все следующие правила в той же цепочке, так что две стратегии для цепочки правил OUTPUT для двух машин действуют по-разному (либо блокируют пинг-ответы, либо пропускают).

#### 4.2. Утилита **nmap**
- Пропингуем соединение между машинами и протестируем утилитой nmap:
<img src="./screen/part4.7.png"/><br>
<img src="./screen/part4.8.png"/><br>

- Из результатов тестирования видно, что ping-запросы с одной машины (ws1) к другой (ws2) проходят, и ответы на них возвращаются успешно. Однако, когда пинг происходит в обратном направлении (от ws2 к ws1), ответы подавляются на стороне ws1, что приводит к тому, что эхо (ответ) на пинг не возвращается.
Тем не менее, сканирование сети с помощью утилиты nmap показывает, что обе машины функционируют и "видны" друг для друга, что указывает на то, что правила iptables правильно настроены и работают

## Part 5. Статическая маршрутизация сети

##### Поднять пять виртуальных машин (3 рабочие станции (ws11, ws21, ws22) и 2 роутера (r1, r2))

#### 5.1. Настройка адресов машин
##### Настроить конфигурации машин в *etc/netplan/00-installer-config.yaml* согласно сети на рисунке.

- Сконфигурировали машины согласно условию задания. Перезапустили службу сети, чтобы все изменения вступили в силу и сделали проверку адресов машин с помощью команды `$ip -4 a**`:
<img src="./screen/part5.1.png"/><br>
<img src="./screen/part5.2.png"/><br>
<img src="./screen/part5.3.png"/><br>
<img src="./screen/part5.4.png"/><br>
<img src="./screen/part5.5.png"/><br>

- Пропинговали ws22 с ws21 и r1 с ws11:
<img src="./screen/part5.6.png"/><br>
<img src="./screen/part5.7.png"/><br>

#### 5.2. Включение переадресации IP-адресов.
- Для включения переадресации IP, выполнили команду `sysctl -w net.ipv4.ip_forward=1` на роутерах:
<img src="./screen/part5.8.png"/><br>
<img src="./screen/part5.9.png"/><br>

- Откройте файл /etc/sysctl.conf и добавили в него следующую строку:
`net.ipv4.ip_forward = 1` для включения IP-переадресация на постоянной основе:
<img src="./screen/part5.10.png"/><br>
<img src="./screen/part5.11.png"/><br>

#### 5.3. Установка маршрута по-умолчанию

- Добавили маршрут по умолчанию для трёх рабочих станций. Внесли изменения в конфигурационный файл, перезапустили сетевую службу и проверили конфигурацию с помощью $ip r.
<img src="./screen/part5.12.png"/><br>
<img src="./screen/part5.13.png"/><br>
<img src="./screen/part5.14.png"/><br>

- Пропинговали с ws11 роутер r2 и показали на r2, что пинг доходит. Для этого использовали команду `tcpdump -tn -i enp0s3`:
<img src="./screen/part5.15.png"/><br>
<img src="./screen/part5.16.png"/><br>

#### 5.4. Добавление статических маршрутов

- Добавили в роутеры r1 и r2 статические маршруты в файле конфигураций, вызвали `ip r` и показали таблицы с маршрутами на обоих роутерах:
<img src="./screen/part5.17.png"/><br>
<img src="./screen/part5.18.png"/><br>

- Запустили команды `ip r list 10.10.0.0/[маска сети]` и `ip r list 0.0.0.0/0` на ws11:
<img src="./screen/part5.19.png"/><br>

- Пояснение: Обращение к адресам, принадлежащим той же сети, что и машина, будет обработано маршрутным правилом, соответствующим этой сети. Адреса, не входящие в сеть машины, будут переданы на обработку маршрутизатору по умолчанию, то есть вовне сети хоста. Поэтому, запрос к адресу 10.10.0.0/18 был обработан как запрос в сети хоста 10.10.0.0, а запрос с адресами 0.0.0.0/0 не входящим в сеть машины (хоста), был передан маршрутизатору по умолчанию 

#### 5.5. Построение списка маршрутизаторов

- Отследим прохождение запросов в нашей сети по маршрутизаторам с помощью команды **traceroute**:
<img src="./screen/part5.20.png"/><br>
<img src="./screen/part5.21.png"/><br>

- Пояснение: traceroute посылает три пакета и отслеживает их прохождения через маршрутизаторы. Время при прохожения и отклике увеличивается на равный промежуток пропорционально пройденным маршрутизаторам до того момента, пока заданный адрес хоста не будет достигнут.

#### 5.6. Использование протокола **ICMP** при маршрутизации

- Запустим на r1 перехват сетевого трафика и пропингуем с ws11 несуществующий IP (например, *10.30.0.111*) с помощью команды:
<img src="./screen/part5.23.png"/><br>
<img src="./screen/part5.22.png"/><br>

## Part 6. Динамическая настройка IP с помощью **DHCP**


- Указали адрес маршрутизатора по-умолчанию, DNS-сервер и адрес внутренней сети для r2:
<img src="./screen/part6.1.png"/><br>

- В файле *resolv.conf* прописали `nameserver 8.8.8.8.`:
<img src="./screen/part6.2.png"/><br>

- Перезагрузили службу **DHCP** командой `systemctl restart isc-dhcp-server`. Машину ws21 перезагрузили при помощи `reboot` и через `ip a` показали, что она получила адрес. Также пропинговали машины ws22 и ws21:
<img src="./screen/part6.3.png"/><br>
<img src="./screen/part6.4.png"/><br>
<img src="./screen/part6.6.png"/><br>

- Указали MAC адрес у ws11, для этого в *etc/netplan/00-installer-config.yaml*  добавили строки: `macaddress: 10:10:10:10:10:BA`, `dhcp4: true`:
<img src="./screen/part6.5.png"/><br>

- Для r1 настроили аналогично r2, но выдачу адресов сделали с жесткой привязкой к MAC-адресу (ws11). Провели аналогичные тесты:
<img src="./screen/part6.7.png"/><br>
<img src="./screen/part6.8.png"/><br>
<img src="./screen/part6.9.png"/><br>
<img src="./screen/part6.10.png"/><br>
<img src="./screen/part6.11.png"/><br>

- Запросить с ws21 обновление ip адреса:
<img src="./screen/part6.12.png"/><br>
<img src="./screen/part6.13.png"/><br>
<img src="./screen/part6.14.png"/><br>

- Пояснение: как видно на скриншоте выше, для смены IP адреса был выполнен полный цикл запросов и ответов между DHCP сервером и DHCP клиентом. А именно был произведён обмен DHCPDISCOVER, DHCPOFFER, DCHPREQUEST и DCHPACK. DHCP сервер при этом использовал все свои настройки - сетевой сегмент, покрываемый сервером, адреса внутренней сети (в которой будут раздаваться динамические IP адреса), маршрутизатора по-умолчанию, и DNS-сервера.

- Результат: успешно настроены и запущены DHCP сервера на маршрутизаторах в двух сегментах сети для динамического выделения IP адресов хостам в этих сегментах.


## Part 7. **NAT**

- В файле /etc/apache2/ports.conf на ws22 и r1 изменили строку Listen 80 на Listen 0.0.0.0:80:
<img src="./screen/part7.1.png"/><br>
<img src="./screen/part7.2.png"/><br>

- Запустили веб-сервер Apache командой service apache2 start на ws22 и r1:
<img src="./screen/part7.3.png"/><br>
<img src="./screen/part7.4.png"/><br>

- Создадим скрипт-файл с правилами для межсетевого экрана iptables и запустим:
<img src="./screen/part7.5.png"/><br>

- Посмотрим созданные правила в таблицах iptables:
<img src="./screen/part7.6.png"/><br>

- Проверим соединение между ws22 и r1 командой `ping`.
<img src="./screen/part7.7.png"/><br>

- Добавим ещё одно правило в iptables позволяющее маршрутизировать все пакеты протокола icmp:
<img src="./screen/part7.8.png"/><br>

- Пропингуем соединение:
<img src="./screen/part7.9.png"/><br>

- Добавим правила SNAT и DNAT и посмотри их в таблице:
<img src="./screen/part7.10.png"/><br>
<img src="./screen/part7.11.png"/><br>

- Проверим действие правила SNAT, доступ к веб-серверу на r1 открыт:
<img src="./screen/part7.12.png"/><br>

- Проверим действие правила DNAT - обращение к веб-серверу ws22 успешно переадресовано с r1 используя порт 8080.
<img src="./screen/part7.13.png"/><br>